name: Django CI / CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# ----------------------------------------------------------------------
# 1Ô∏è‚É£  –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ —Ä–µ–ø–æ‚Äë—Å–µ–∫—Ä–µ—Ç–∞—Ö)
# ----------------------------------------------------------------------
env:
  # Python version, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞–∂–¥–æ–º job'–µ
  PYTHON_VERSION: "3.10"

  # –ö–ª—é—á–∏ –¥–ª—è Docker‚ÄëHub (–∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ Settings ‚Üí Secrets ‚Üí Actions)
  DOCKER_HUB_USERNAME: ""
  DOCKER_HUB_TOKEN: ""

  # SSH‚Äë–¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–¥–∞–∫—à–Ω‚Äë—Å–µ—Ä–≤–µ—Ä—É
  DEPLOY_SSH_PRIVATE_KEY: ""          # multi‚Äëline secret
  DEPLOY_SSH_USER: ""
  DEPLOY_SERVER_IP: ""

# ----------------------------------------------------------------------
# 2Ô∏è‚É£  –û–±—â–∞—è composite‚Äëaction –¥–ª—è Python‚Äë–æ–∫—Ä—É–∂–µ–Ω–∏—è
# ----------------------------------------------------------------------
x/python-setup: &python-setup
  uses: actions/setup-python@v5
  with:
    python-version: ${{ env.PYTHON_VERSION }}

  # –ö–µ—à–∏—Ä—É–µ–º pip‚Äë–ø–∞–∫–µ—Ç—ã –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
  - name: Cache pip
    uses: actions/cache@v3
    with:
      path: ~/.cache/pip
      key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
      restore-keys: |
        ${{ runner.os }}-pip-

  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤—Å–µ –∏–∑ requirements*.txt)
  - name: Install Python dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      # –ï—Å–ª–∏ –µ—Å—Ç—å dev‚Äë–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Ç–µ—Å—Ç—ã, lint) ‚Äì —É—Å—Ç–∞–Ω–æ–≤–∏–º –∏—Ö —Ç–æ–∂–µ
      if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

# ----------------------------------------------------------------------
# 3Ô∏è‚É£  Job: Lint (flake8 + mypy)
# ----------------------------------------------------------------------
jobs:
  lint:
    name: Lint (flake8 + mypy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 mypy  # –¥–æ–±–∞–≤–∏–º mypy –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏

      - name: Run flake8
        run: flake8 .

      - name: Run mypy
        # –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ ‚Äì –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
        run: mypy web

# ----------------------------------------------------------------------
# 4Ô∏è‚É£  Job: Test (DB + migrations + test suite)
# ----------------------------------------------------------------------
  test:
    name: Test (Postgres + pytest)
    runs-on: ubuntu-latest
    needs: lint
    services:
      # –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å‚Äë–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        ports: ["5432:5432"]
        # –ñ–¥—ë–º, –ø–æ–∫–∞ –ë–î –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
        options: >-
          --health-cmd "pg_isready -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }}"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5

    env:
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@${{ env.POSTGRES_HOST }}:${{ env.POSTGRES_PORT }}/${{ env.POSTGRES_DB }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----- –û–±—â–∏–π Python‚Äësetup (–∫–µ—à, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏) -----
      - <<: *python-setup

      # ----- –ñ–¥—ë–º, –ø–æ–∫–∞ PostgreSQL –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–æ—Ç–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) -----
      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U $POSTGRES_USER && break
            echo "Postgres not ready yet, retry $i..."
            sleep 3
          done

      # ----- –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Ç–µ—Å—Ç—ã -----
      - name: Apply migrations
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: python manage.py migrate

      - name: Run test suite
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: python manage.py test

# ----------------------------------------------------------------------
# 5Ô∏è‚É£  Job: Build Docker image (uses Docker Hub credentials)
# ----------------------------------------------------------------------
  build:
    name: Build & Push Docker image
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
      # –Ω—É–∂–µ–Ω –¥–ª—è push‚Äëaction
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----- Docker‚Äëlogin (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é action) -----
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # ----- Build & push (–º—É–ª—å—Ç–∏‚Äëtag: latest + sha) -----
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./web                     # <-- –ø—É—Ç—å –∫ Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/myapp:cache
          cache-to: type=registry,ref=${{ secrets.DOCKER_HUB_USERNAME }}/myapp:cache,mode=max
          # –í–∫–ª—é—á–∞–µ–º BuildKit (–±—ã—Å—Ç—Ä–µ–µ, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏)
          push: true
          provenance: false

# ----------------------------------------------------------------------
# 6Ô∏è‚É£  Job: Deploy (SSH‚Äëbased)
# ----------------------------------------------------------------------
  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'   # –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –∏–∑ main
    steps:
      # ----- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SSH‚Äë–∫–ª—é—á–∞ -----
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_SERVER }}

      # ----- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ IP –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–Ω—ã -----
      - name: Verify deployment variables
        run: |
          if [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SERVER_IP }}" ]; then
            echo "‚ùå  SSH_USER or SERVER_IP secret is missing"
            exit 1
          fi

      # ----- –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ -----
      - name: Deploy to production
        env:
          IMAGE_NAME: ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} <<'EOF'
            set -e
            echo "üîΩ Pulling latest image..."
            docker pull $IMAGE_NAME

            echo "üõë Stopping & removing old container (if any)..."
            docker stop myapp || true
            docker rm myapp || true

            echo "üöÄ Starting new container..."
            docker run -d \
              --name myapp \
              -p 80:8000 \
              --restart unless-stopped \
              $IMAGE_NAME
          EOF


#name: Django CI
#
#on: [push, pull_request]
#
#jobs:
#  lint:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Check out code
#        uses: actions/checkout@v3
#
#      - name: Set up Python
#        uses: actions/setup-python@v4
#        with:
#          python-version: '3.10'
#
#      - name: Install flake8
#        run: |
#          python -m pip install --upgrade pip
#          pip install flake8
#
#      - name: Run Flake8
#        run: flake8 .
#
#  test:
#    runs-on: ubuntu-latest
#    needs: lint
#
#    steps:
#      - name: Check out code
#        uses: actions/checkout@v3
#
#      - name: Set up Python
#        uses: actions/setup-python@v4
#        with:
#          python-version: '3.10'
#
#      - name: Cache pip
#        uses: actions/cache@v3
#        with:
#          path: ~/.cache/pip
#          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
#          restore-keys: ${{ runner.os }}-pip-
#
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          pip install -r requirements.txt
#
#      - name: Run migrations
#        run: python manage.py migrate
#
#      - name: Run tests
#        run: python manage.py test
#
#  build:
#    runs-on: ubuntu-latest
#    needs: test
#
#    steps:
#      - name: Check out code
#        uses: actions/checkout@v3
#
#      - name: Log in to Docker Hub
#        run: echo ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} | docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin
#
#      - name: Build Docker image
#        run: docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }} .
#
#      - name: Push Docker image to Docker Hub
#        run: docker push ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }}
#
#  deploy:
#    runs-on: ubuntu-latest
#    needs: build
#
#    steps:
#      - name: Set up SSH
#        uses: webfactory/ssh-agent@v0.8.1
#        with:
#          ssh-private-keys: ${{ secrets.SSH_KEY_SERVER }}
#
#      - name: Deploy to server
#        run: |
#          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
#          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }}
#          docker stop myapp || true
#          docker rm myapp || true
#          docker run -d --name myapp -p 80:8000 ${{ secrets.DOCKER_HUB_USERNAME }}/myapp:${{ github.sha }}
#          EOF
          

#      - name: Copy project files to server
#        run: |
#          rsync -avz --exclude '__pycache__' . ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.DEPLOY_DIR }}
#
#      - name: Install dependencies on server
#        run: |
#          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
#            cd ${{ secrets.DEPLOY_DIR }}
#            python3 -m venv venv
#            source venv/bin/activate
#            pip install -r requirements.txt
#          EOF
#
#      - name: Apply migrations on server
#        run: |
#          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
#            cd ${{ secrets.DEPLOY_DIR }}
#            source venv/bin/activate
#            python manage.py migrate
#          EOF
#
#      - name: Collect static files on server
#        run: |
#          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
#            cd ${{ secrets.DEPLOY_DIR }}
#            source venv/bin/activate
#            python manage.py collectstatic --noinput
#          EOF
#
#      - name: Restart application
#        run: |
#          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
#            sudo systemctl restart myapp.service
#          EOF
